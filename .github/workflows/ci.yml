# .github/workflows/ci.yml

name: MLflow CI - MARGOHAN

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # Checkout repository
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # Setup Python 
    # -----------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # -----------------------------
    # Install dependencies (Menggunakan requirements.txt)
    # -----------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Pastikan docker terinstall untuk mlflow build-docker
        pip install mlflow==2.19.0 scikit-learn pandas docker

    # -----------------------------
    # Jalankan MLflow Project (Menangkap RUN_ID)
    # -----------------------------
    - name: Run MLflow Project and Capture Run ID
      id: run_project
      run: |
        cd MLProject
        # Menjalankan MLflow Project dan menangkap Run ID dari output
        # Perintah grep/awk diperbaiki agar lebih andal menangkap RUN ID
        RUN_ID=$(mlflow run . --env-manager=local 2>&1 | grep "Running command" | awk '{print $NF}')
        echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "Telah melatih model dalam run ID: $RUN_ID"

    # =================================================================
    # ðŸš€ ADVANCE (4 PTS): DOCKER BUILD DAN PUSH
    # =================================================================
    
    # -----------------------------
    # Docker Hub Login (Step 1)
    # -----------------------------
    - name: Docker Login
      uses: docker/login-action@v3
      with:
        # Menggunakan GitHub Secrets
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # -----------------------------
    # Build Docker Image menggunakan MLflow dan Push (Step 2)
    # -----------------------------
    - name: Build and Push Docker Image
      run: |
        # Menggunakan Run ID yang ditangkap dari langkah sebelumnya
        MODEL_URI="runs:/${{ env.MLFLOW_RUN_ID }}/best_model_ci_artifact"
        
        # Nama Image: ${{ secrets.DOCKER_USERNAME }} akan menjadi "gohandal1"
        IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/margohan-credit-model"
        IMAGE_TAG="${{ github.sha }}" # Menggunakan SHA Commit sebagai tag unik
        
        echo "Building Docker image ${IMAGE_NAME}:${IMAGE_TAG} dari Model URI: ${MODEL_URI}"
        
        # Build Docker Image menggunakan fungsi MLflow
        mlflow build-docker --model-uri ${MODEL_URI} --name ${IMAGE_NAME} --tag ${IMAGE_TAG}
        
        # Push Image ke Docker Hub
        docker push ${IMAGE_NAME}:${IMAGE_TAG}
      shell: bash

    # -----------------------------
    # Upload model artifact (Skilled Step - Model PKL)
    # -----------------------------
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model-${{ github.run_id }}
        path: MLProject/model_best.pkl
        retention-days: 7