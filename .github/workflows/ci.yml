name: MLflow CI - MARGOHAN

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    
    runs-on: ubuntu-latest
    
    # Environment variables untuk MLflow (opsional, tapi disarankan)
    # env:
    #   MLFLOW_TRACKING_URI: file:./MLProject/mlruns 

    steps:
    # -----------------------------
    # Checkout repository
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # Setup Conda (untuk menjalankan MLflow Project)
    # -----------------------------
    - name: Setup Conda Environment
      uses: conda-incubator/setup-miniconda@v3
      with:
        activate-environment: margohan_env # Nama environment dari conda.yaml
        environment-file: MLProject/conda.yaml # Jalur ke conda.yaml
        python-version: 3.10
        auto-activate-base: false

    # -----------------------------
    # Install dependencies
    # -----------------------------
    - name: Install MLflow CLI (jika belum ada)
      shell: bash
      run: |
        # Pastikan mlflow terinstal di environment yang aktif
        conda install -c conda-forge mlflow -y 
        # Atau jika menggunakan pip (tapi conda lebih disarankan untuk MLflow Project)
        # pip install mlflow==2.19.0

    # -----------------------------
    # Menjalankan MLflow Project
    # -----------------------------
    - name: Run MLflow Project
      shell: bash
      run: |
        cd MLProject
        # MLflow akan membaca MLProject, menggunakan conda.yaml, dan menjalankan modelling.py
        # Parameter --env-manager=conda adalah cara untuk ini
        mlflow run . --env-manager=conda 

    # -----------------------------
    # Upload model artifact (SKILLED: Menyimpan artefak ke repositori/Actions)
    # -----------------------------
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model-${{ github.run_id }}

        path: MLProject/model_best.pkl
        retention-days: 7